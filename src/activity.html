<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aktivitet - HPK 14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <a href="index.html" class="text-blue-200 hover:text-white text-sm">&larr; Tilbage til aktiviteter</a>
            <h1 id="activity-name" class="text-3xl font-bold mt-2">Henter...</h1>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
        </div>

        <div id="not-found" class="hidden text-center py-12">
            <p class="text-gray-500 text-lg">Aktivitet ikke fundet</p>
            <a href="index.html" class="text-blue-600 hover:underline">Tilbage til forsiden</a>
        </div>

        <div id="activity-content" class="hidden max-w-2xl mx-auto">
            <!-- Activity details -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <span id="activity-type" class="inline-block px-3 py-1 text-sm font-semibold rounded"></span>
                        <span id="activity-date" class="text-gray-600"></span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEditModal()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Rediger
                        </button>
                        <button onclick="deleteActivity()" class="text-red-600 hover:text-red-800 text-sm font-medium">
                            Slet
                        </button>
                    </div>
                </div>
                <p class="text-gray-700 mb-2">
                    <span class="font-medium">Sted:</span> <span id="activity-location"></span>
                </p>
                <p id="activity-max" class="text-gray-700 mb-2 hidden">
                    <span class="font-medium">Maks deltagere:</span> <span id="max-value"></span>
                </p>
                <p id="activity-description" class="text-gray-700 mb-4 hidden">
                    <span class="font-medium">Beskrivelse:</span> <span id="description-value"></span>
                </p>
                <button onclick="addToCalendar()" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm font-medium py-2 px-4 rounded-lg transition">
                    Tilføj til kalender
                </button>
            </div>

            <!-- Response form -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Hvad vil du?</h2>
                <div class="space-y-4">
                    <input type="text" id="response-name"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg"
                        placeholder="Skriv dit navn">
                    <div class="flex gap-3">
                        <button onclick="submitResponse('signup')" id="signup-btn"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
                            <span>Tilmeld</span>
                        </button>
                        <button onclick="submitResponse('unavailable')" id="unavailable-btn"
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
                            <span>Afmeld</span>
                        </button>
                    </div>
                    <p id="response-error" class="hidden text-red-600 text-sm text-center"></p>
                    <p id="signup-full" class="hidden text-orange-600 text-sm text-center">Aktiviteten er fuld - du kan ikke tilmelde dig</p>
                </div>
            </div>

            <!-- Response lists -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Tilmeldinger list -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-green-700 mb-4">
                        Tilmeldinger (<span id="signup-count">0</span>)
                    </h2>
                    <div id="no-signups" class="text-gray-500">Ingen endnu</div>
                    <ul id="signups-list" class="space-y-2 hidden"></ul>
                </div>
                <!-- Afmeldinger list -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-red-700 mb-4">
                        Afmeldinger (<span id="unavailable-count">0</span>)
                    </h2>
                    <div id="no-unavailable" class="text-gray-500">Ingen endnu</div>
                    <ul id="unavailable-list" class="space-y-2 hidden"></ul>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Rediger aktivitet</h2>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
                    </div>
                    <form id="edit-form" class="space-y-4">
                        <div>
                            <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">Aktivitetsnavn *</label>
                            <input type="text" id="edit-name" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="edit-type" class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                            <select id="edit-type" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="training">Træning</option>
                                <option value="match">Kamp</option>
                                <option value="social">Social</option>
                                <option value="other">Andet</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-date" class="block text-sm font-medium text-gray-700 mb-1">Dato og tid *</label>
                            <input type="datetime-local" id="edit-date" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="edit-location" class="block text-sm font-medium text-gray-700 mb-1">Sted *</label>
                            <input type="text" id="edit-location" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="edit-maxParticipants" class="block text-sm font-medium text-gray-700 mb-1">Maks deltagere</label>
                            <input type="number" id="edit-maxParticipants" min="1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1">Beskrivelse</label>
                            <textarea id="edit-description" rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div id="edit-error" class="hidden text-red-600 text-sm"></div>
                        <div class="flex gap-3">
                            <button type="button" onclick="closeEditModal()"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                                Annuller
                            </button>
                            <button type="submit" id="edit-submit-btn"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                                Gem ændringer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        let currentActivity = null;

        document.addEventListener('DOMContentLoaded', loadActivity);

        async function loadActivity() {
            const params = new URLSearchParams(window.location.search);
            const activityId = params.get('id');

            if (!activityId) {
                showNotFound();
                return;
            }

            try {
                const data = await api.getActivity(activityId);
                currentActivity = data.activity;
                renderActivity(data.activity, data.signups, data.unavailable);
            } catch (error) {
                console.error('Error loading activity:', error);
                showNotFound();
            }
        }

        function showNotFound() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('not-found').classList.remove('hidden');
        }

        function renderActivity(activity, signups, unavailable) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('activity-content').classList.remove('hidden');

            document.getElementById('activity-name').textContent = activity.name;
            document.title = `${activity.name} - HPK 14`;

            const typeEl = document.getElementById('activity-type');
            typeEl.textContent = getTypeLabel(activity.type);
            typeEl.className = `inline-block px-3 py-1 text-sm font-semibold rounded ${getTypeColor(activity.type)}`;

            document.getElementById('activity-date').textContent = formatDate(activity.date);
            document.getElementById('activity-location').textContent = activity.location;

            if (activity.maxParticipants) {
                document.getElementById('activity-max').classList.remove('hidden');
                document.getElementById('max-value').textContent = activity.maxParticipants;
            }

            if (activity.description) {
                document.getElementById('activity-description').classList.remove('hidden');
                document.getElementById('description-value').textContent = activity.description;
            }

            renderSignups(signups, activity.maxParticipants);
            renderUnavailable(unavailable);
        }

        let isActivityFull = false;

        function renderSignups(signups, maxParticipants) {
            const countEl = document.getElementById('signup-count');
            const noSignups = document.getElementById('no-signups');
            const signupsList = document.getElementById('signups-list');
            const signupFull = document.getElementById('signup-full');
            const signupBtn = document.getElementById('signup-btn');

            countEl.textContent = signups.length;

            isActivityFull = maxParticipants && signups.length >= parseInt(maxParticipants);
            if (isActivityFull) {
                signupFull.classList.remove('hidden');
                signupBtn.disabled = true;
                signupBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                signupFull.classList.add('hidden');
                signupBtn.disabled = false;
                signupBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            if (signups.length === 0) {
                noSignups.classList.remove('hidden');
                signupsList.classList.add('hidden');
                return;
            }

            noSignups.classList.add('hidden');
            signupsList.classList.remove('hidden');
            signupsList.innerHTML = signups.map(signup => `
                <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium">${escapeHtml(signup.name)}</span>
                    <button onclick="removeSignup('${signup.id}', '${escapeHtml(signup.name)}')"
                        class="text-gray-600 hover:text-gray-800 text-sm">
                        Fjern
                    </button>
                </li>
            `).join('');
        }

        function renderUnavailable(unavailable) {
            const countEl = document.getElementById('unavailable-count');
            const noUnavailable = document.getElementById('no-unavailable');
            const unavailableList = document.getElementById('unavailable-list');

            countEl.textContent = unavailable.length;

            if (unavailable.length === 0) {
                noUnavailable.classList.remove('hidden');
                unavailableList.classList.add('hidden');
                return;
            }

            noUnavailable.classList.add('hidden');
            unavailableList.classList.remove('hidden');
            unavailableList.innerHTML = unavailable.map(item => `
                <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium">${escapeHtml(item.name)}</span>
                    <button onclick="removeUnavailable('${item.id}', '${escapeHtml(item.name)}')"
                        class="text-gray-600 hover:text-gray-800 text-sm">
                        Fjern
                    </button>
                </li>
            `).join('');
        }

        async function submitResponse(type) {
            const nameInput = document.getElementById('response-name');
            const signupBtn = document.getElementById('signup-btn');
            const unavailableBtn = document.getElementById('unavailable-btn');
            const errorEl = document.getElementById('response-error');

            const name = nameInput.value.trim();
            if (!name) {
                errorEl.textContent = 'Skriv dit navn først';
                errorEl.classList.remove('hidden');
                nameInput.focus();
                return;
            }

            if (type === 'signup' && isActivityFull) {
                return;
            }

            const btn = type === 'signup' ? signupBtn : unavailableBtn;
            const originalText = btn.querySelector('span').textContent;

            signupBtn.disabled = true;
            unavailableBtn.disabled = true;
            btn.querySelector('span').textContent = type === 'signup' ? 'Tilmelder...' : 'Afmelder...';
            errorEl.classList.add('hidden');

            try {
                if (type === 'signup') {
                    await api.signup(currentActivity.id, name);
                } else {
                    await api.markUnavailable(currentActivity.id, name);
                }
                nameInput.value = '';
                await loadActivity();
            } catch (error) {
                errorEl.textContent = type === 'signup'
                    ? 'Kunne ikke tilmelde. Prøv igen.'
                    : 'Kunne ikke afmelde. Prøv igen.';
                errorEl.classList.remove('hidden');
            } finally {
                signupBtn.disabled = isActivityFull;
                unavailableBtn.disabled = false;
                btn.querySelector('span').textContent = originalText;
            }
        }

        // Allow Enter key to submit as signup
        document.getElementById('response-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!isActivityFull) {
                    submitResponse('signup');
                }
            }
        });

        async function removeUnavailable(unavailableId, name) {
            if (!confirm(`Er du sikker på, at du vil fjerne ${name} fra listen?`)) {
                return;
            }

            try {
                await api.removeUnavailable(currentActivity.id, unavailableId);
                await loadActivity();
            } catch (error) {
                alert('Kunne ikke fjerne fra listen. Prøv igen.');
            }
        }

        async function removeSignup(signupId, name) {
            if (!confirm(`Er du sikker på, at du vil fjerne ${name} fra listen?`)) {
                return;
            }

            try {
                await api.removeSignup(currentActivity.id, signupId);
                await loadActivity();
            } catch (error) {
                alert('Kunne ikke fjerne fra listen. Prøv igen.');
            }
        }

        function openEditModal() {
            const modal = document.getElementById('edit-modal');
            document.getElementById('edit-name').value = currentActivity.name;
            document.getElementById('edit-type').value = currentActivity.type;
            document.getElementById('edit-date').value = currentActivity.date;
            document.getElementById('edit-location').value = currentActivity.location;
            document.getElementById('edit-maxParticipants').value = currentActivity.maxParticipants || '';
            document.getElementById('edit-description').value = currentActivity.description || '';
            document.getElementById('edit-error').classList.add('hidden');
            modal.classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('edit-submit-btn');
            const errorEl = document.getElementById('edit-error');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Gemmer...';
            errorEl.classList.add('hidden');

            const formData = {
                name: document.getElementById('edit-name').value,
                type: document.getElementById('edit-type').value,
                date: document.getElementById('edit-date').value,
                location: document.getElementById('edit-location').value,
                maxParticipants: document.getElementById('edit-maxParticipants').value || null,
                description: document.getElementById('edit-description').value || null
            };

            try {
                await api.updateActivity(currentActivity.id, formData);
                closeEditModal();
                await loadActivity();
            } catch (error) {
                if (error.message === 'Invalid team code') {
                    errorEl.textContent = 'Forkert holdkode. Prøv igen.';
                } else if (error.message === 'Team code required') {
                    errorEl.textContent = 'Holdkode er påkrævet.';
                } else {
                    errorEl.textContent = 'Kunne ikke gemme ændringer. Prøv igen.';
                }
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Gem ændringer';
            }
        });

        async function deleteActivity() {
            if (!confirm('Er du sikker på, at du vil slette denne aktivitet? Alle tilmeldinger vil også blive slettet.')) {
                return;
            }

            try {
                await api.deleteActivity(currentActivity.id);
                window.location.href = 'index.html';
            } catch (error) {
                if (error.message === 'Invalid team code') {
                    alert('Forkert holdkode. Prøv igen.');
                } else if (error.message === 'Team code required') {
                    alert('Holdkode er påkrævet.');
                } else {
                    alert('Kunne ikke slette aktivitet. Prøv igen.');
                }
            }
        }

        function addToCalendar() {
            const activity = currentActivity;
            const startDate = new Date(activity.date);
            const endDate = new Date(startDate.getTime() + 2 * 60 * 60 * 1000); // 2 hours duration

            // Format date as local time for ICS (YYYYMMDDTHHMMSS)
            const formatICSDateLocal = (date) => {
                const pad = (n) => n.toString().padStart(2, '0');
                return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}T${pad(date.getHours())}${pad(date.getMinutes())}${pad(date.getSeconds())}`;
            };

            const escapeICS = (text) => {
                return text ? text.replace(/[,;\\]/g, '\\$&').replace(/\n/g, '\\n') : '';
            };

            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//HPK 14//Padel//DA',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'BEGIN:VEVENT',
                `UID:${activity.id}@hpk14.dk`,
                `DTSTAMP:${formatICSDateLocal(new Date())}`,
                `DTSTART:${formatICSDateLocal(startDate)}`,
                `DTEND:${formatICSDateLocal(endDate)}`,
                `SUMMARY:${escapeICS(activity.name)} - HPK 14`,
                `LOCATION:${escapeICS(activity.location)}`,
                activity.description ? `DESCRIPTION:${escapeICS(activity.description)}` : '',
                'END:VEVENT',
                'END:VCALENDAR'
            ].filter(line => line).join('\r\n');

            // Use data URL - works on iOS Safari unlike Blob URLs
            const dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icsContent);

            // For iOS, open in same window to trigger calendar import
            // For other browsers, try download first
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (isIOS) {
                window.location.href = dataUrl;
            } else {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `${activity.name.replace(/[^a-zA-Z0-9æøåÆØÅ ]/g, '')}.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>
